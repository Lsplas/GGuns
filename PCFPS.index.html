<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PolyCombat: Boss Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', sans-serif; user-select: none; }
        
        /* UI OVERLAY */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: #00ff00; border: 2px solid white; border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #00ff00;
        }

        /* HUD */
        #hud-top {
            position: absolute; top: 20px; right: 20px; text-align: right;
            font-weight: bold; font-size: 20px;
        }
        .currency { margin-bottom: 5px; text-shadow: 2px 2px 0 #000; }
        
        #hud-bottom {
            position: absolute; bottom: 20px; left: 20px;
            font-size: 24px; color: white; font-weight: bold;
            display: flex; gap: 20px;
        }
        
        /* BOSS BAR */
        #boss-container {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            width: 50%; display: none;
        }
        #boss-label { color: red; text-align: center; font-weight: bold; text-shadow: 0 0 5px red; }
        #boss-bar-bg { width: 100%; height: 20px; background: #330000; border: 2px solid red; }
        #boss-bar-fill { width: 100%; height: 100%; background: red; transition: width 0.1s; }

        /* DAMAGE FLASH */
        #red-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s;
        }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,10,0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: auto; z-index: 10;
        }
        .btn {
            background: #ff0044; color: white; padding: 20px 40px; font-size: 24px; font-weight: bold;
            border: 2px solid white; cursor: pointer; margin-top: 20px;
        }
        .btn:hover { background: white; color: black; }

    </style>
</head>
<body>

    <div id="red-flash"></div>

    <div id="start-screen">
        <h1 style="color: white; font-size: 50px; margin: 0;">BOSS BATTLE</h1>
        <p style="color: #ccc;">WASD = Move | ARROWS = Look | CLICK = Shoot</p>
        <button class="btn" id="start-btn">FIGHT BOSS</button>
    </div>

    <div id="ui-layer">
        <div id="boss-container">
            <div id="boss-label">BOSS HP</div>
            <div id="boss-bar-bg"><div id="boss-bar-fill"></div></div>
        </div>

        <div id="hud-top">
            <div class="currency" style="color:gold">ü™ô <span id="coins">0</span></div>
            <div class="currency" style="color:magenta">üíé <span id="gems">0</span></div>
        </div>

        <div id="crosshair"></div>

        <div id="hud-bottom">
            <div style="color: #ff3333">‚ù§Ô∏è <span id="hp">100</span></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import * as CANNON from 'cannon-es';

        // --- GAME CONFIG ---
        const GAME = {
            active: false,
            coins: 0, gems: 0,
            hp: 100,
            bossLevel: 1
        };

        // --- SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        scene.fog = new THREE.Fog(0x222222, 10, 60);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Light
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 50, 20);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        // Physics
        const world = new CANNON.World();
        world.gravity.set(0, -40, 0); // Snappy gravity
        
        const mat = new CANNON.Material();
        const contact = new CANNON.ContactMaterial(mat, mat, { friction: 0.0, restitution: 0.0 });
        world.addContactMaterial(contact);

        // --- PLAYER ---
        const playerBody = new CANNON.Body({
            mass: 5, shape: new CANNON.Sphere(1.5),
            material: mat, fixedRotation: true
        });
        playerBody.position.set(0, 5, 20);
        playerBody.linearDamping = 0.9;
        world.addBody(playerBody);

        // --- COOL GUN MODEL ---
        const gunGroup = new THREE.Group();
        
        // 1. Main Body
        const bodyGeo = new THREE.BoxGeometry(0.15, 0.2, 0.6);
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
        const bodyMesh = new THREE.Mesh(bodyGeo, bodyMat);
        gunGroup.add(bodyMesh);

        // 2. Barrel
        const barrelGeo = new THREE.BoxGeometry(0.05, 0.05, 0.6);
        const barrelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const barrel = new THREE.Mesh(barrelGeo, barrelMat);
        barrel.position.set(0, 0.05, -0.6);
        gunGroup.add(barrel);

        // 3. Magazine
        const magGeo = new THREE.BoxGeometry(0.08, 0.3, 0.15);
        const mag = new THREE.Mesh(magGeo, bodyMat);
        mag.position.set(0, -0.2, -0.1);
        gunGroup.add(mag);

        // 4. Scope
        const scopeGeo = new THREE.BoxGeometry(0.06, 0.06, 0.2);
        const scope = new THREE.Mesh(scopeGeo, new THREE.MeshStandardMaterial({color: 0x000000}));
        scope.position.set(0, 0.15, -0.1);
        gunGroup.add(scope);

        gunGroup.position.set(0.4, -0.3, -0.5);
        camera.add(gunGroup);
        scene.add(camera);

        // --- ENTITY MANAGER ---
        const enemies = [];
        
        class Boss {
            constructor() {
                this.maxHp = 1500 * GAME.bossLevel;
                this.hp = this.maxHp;
                this.lastAttack = 0;

                // Visuals
                const geo = new THREE.BoxGeometry(4, 8, 4);
                const mat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.position.set(0, 5, -30);
                this.mesh.castShadow = true;
                scene.add(this.mesh);

                // Physics
                this.body = new CANNON.Body({
                    mass: 50,
                    shape: new CANNON.Box(new CANNON.Vec3(2, 4, 2)),
                    material: mat,
                    fixedRotation: true
                });
                this.body.position.set(0, 5, -30);
                world.addBody(this.body);

                // UI
                document.getElementById('boss-container').style.display = 'block';
                this.updateUI();
            }

            update(playerPos, dt) {
                // 1. Chase Player
                const dir = new THREE.Vector3().subVectors(playerPos, this.body.position);
                dir.y = 0; // Don't fly
                dir.normalize();
                
                const speed = 8 + (GAME.bossLevel); // Gets faster
                this.body.velocity.x = dir.x * speed;
                this.body.velocity.z = dir.z * speed;
                
                // Sync Mesh
                this.mesh.position.copy(this.body.position);
                this.mesh.lookAt(playerPos);

                // 2. Attack Player
                const dist = this.body.position.distanceTo(playerPos);
                if (dist < 4.0 && Date.now() - this.lastAttack > 1000) {
                    this.lastAttack = Date.now();
                    takeDamage(15);
                    // Push player back
                    playerBody.velocity.x += dir.x * 30;
                    playerBody.velocity.z += dir.z * 30;
                }
            }

            takeDamage(amt) {
                this.hp -= amt;
                this.mesh.material.emissive.setHex(0xffaaaa);
                setTimeout(() => this.mesh.material.emissive.setHex(0x000000), 50);
                this.updateUI();

                if(this.hp <= 0) {
                    scene.remove(this.mesh);
                    world.removeBody(this.body);
                    enemies.splice(0, 1);
                    
                    GAME.coins += 1000;
                    GAME.gems += 500;
                    updateHUD();
                    alert("BOSS DEFEATED! +1000 Coins");
                    
                    GAME.bossLevel++;
                    setTimeout(() => enemies.push(new Boss()), 3000);
                }
            }

            updateUI() {
                const pct = (this.hp / this.maxHp) * 100;
                document.getElementById('boss-bar-fill').style.width = pct + '%';
            }
        }

        // --- MAP ---
        function createFloor(w, d) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(w, 1, d), new THREE.MeshStandardMaterial({color: 0x444444}));
            m.position.y = -0.5;
            scene.add(m);
            const b = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(w/2, 0.5, d/2)) });
            b.position.y = -0.5;
            world.addBody(b);
        }
        createFloor(100, 100);

        // Add Dummies
        function createDummy(x, z) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshStandardMaterial({color: 0x00ff00}));
            m.position.set(x, 2, z);
            scene.add(m);
            const b = new CANNON.Body({ mass: 5, shape: new CANNON.Box(new CANNON.Vec3(1,2,1)) });
            b.position.set(x, 2, z);
            world.addBody(b);
            return { mesh: m, body: b, hp: 500 };
        }
        const dummies = [createDummy(-20, 0), createDummy(-25, 5)];

        // --- CONTROLS ---
        const controls = new PointerLockControls(camera, document.body);
        const keys = { w:0, a:0, s:0, d:0, up:0, down:0, left:0, right:0, sp:0 };

        document.getElementById('start-btn').addEventListener('click', () => {
            controls.lock();
            document.getElementById('start-screen').style.display = 'none';
            GAME.active = true;
            enemies.push(new Boss());
        });

        document.addEventListener('keydown', e => {
            switch(e.key.toLowerCase()) {
                case 'w': keys.w = 1; break;
                case 's': keys.s = 1; break;
                case 'a': keys.a = 1; break;
                case 'd': keys.d = 1; break;
                case ' ': keys.sp = 1; break;
                case 'arrowup': keys.up = 1; break;
                case 'arrowdown': keys.down = 1; break;
                case 'arrowleft': keys.left = 1; break;
                case 'arrowright': keys.right = 1; break;
            }
        });
        document.addEventListener('keyup', e => {
            switch(e.key.toLowerCase()) {
                case 'w': keys.w = 0; break;
                case 's': keys.s = 0; break;
                case 'a': keys.a = 0; break;
                case 'd': keys.d = 0; break;
                case ' ': keys.sp = 0; break;
                case 'arrowup': keys.up = 0; break;
                case 'arrowdown': keys.down = 0; break;
                case 'arrowleft': keys.left = 0; break;
                case 'arrowright': keys.right = 0; break;
            }
        });
        document.addEventListener('mousedown', () => { if(GAME.active) shoot(); });

        // --- SHOOTING ---
        const bullets = [];
        function shoot() {
            // Visual Recoil
            gunGroup.position.z = -0.3;
            gunGroup.rotation.x = 0.2;

            const geo = new THREE.SphereGeometry(0.2);
            const mat = new THREE.MeshBasicMaterial({color: 0xffff00});
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.copy(camera.position);
            scene.add(mesh);

            const body = new CANNON.Body({ mass: 0.1, shape: new CANNON.Sphere(0.2) });
            body.position.copy(camera.position);
            
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            body.velocity.set(dir.x * 100, dir.y * 100, dir.z * 100);
            world.addBody(body);

            bullets.push({ mesh, body, life: 60 });
        }

        function takeDamage(amt) {
            GAME.hp -= amt;
            document.getElementById('hp').innerText = GAME.hp;
            document.getElementById('red-flash').style.opacity = 0.6;
            setTimeout(() => document.getElementById('red-flash').style.opacity = 0, 100);
            
            if(GAME.hp <= 0) {
                alert("YOU DIED. COINS: " + GAME.coins);
                location.reload();
            }
        }

        function updateHUD() {
            document.getElementById('coins').innerText = GAME.coins;
            document.getElementById('gems').innerText = GAME.gems;
        }

        // --- GAME LOOP ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            if(!GAME.active) return;

            const dt = Math.min(clock.getDelta(), 0.1);
            world.step(1/60, dt, 3);

            // 1. MOVEMENT & LOOK
            // Arrow Key Looking (Manual Rotation)
            const lookSpeed = 2.0 * dt;
            if(keys.left) camera.rotation.y += lookSpeed;
            if(keys.right) camera.rotation.y -= lookSpeed;
            if(keys.up) camera.rotation.x += lookSpeed;
            if(keys.down) camera.rotation.x -= lookSpeed;

            // Movement Physics
            const yaw = camera.rotation.y; // Standard ThreeJS rotation
            // NOTE: When using PointerLockControls, we usually get yaw from camera.
            // But if using arrows, we are modifying camera rotation directly.
            
            const input = new THREE.Vector3(0,0,0);
            if(keys.w) input.z -= 1;
            if(keys.s) input.z += 1;
            if(keys.a) input.x -= 1;
            if(keys.d) input.x += 1;

            // Rotate input by Camera Yaw
            input.applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y); 

            // High Speed (25)
            const speed = 25; 
            playerBody.velocity.x = input.x * speed;
            playerBody.velocity.z = input.z * speed;

            if(keys.sp && Math.abs(playerBody.velocity.y) < 0.1) {
                playerBody.velocity.y = 15;
            }

            // Sync Camera
            camera.position.copy(playerBody.position).add(new THREE.Vector3(0, 1.5, 0));

            // Gun Recoil Recovery
            gunGroup.position.z = THREE.MathUtils.lerp(gunGroup.position.z, -0.5, 0.1);
            gunGroup.rotation.x = THREE.MathUtils.lerp(gunGroup.rotation.x, 0, 0.1);

            // 2. BOSS LOGIC
            enemies.forEach(boss => boss.update(playerBody.position, dt));

            // 3. DUMMY LOGIC
            dummies.forEach((d, i) => {
                d.mesh.position.copy(d.body.position);
                if(d.hp <= 0 && d.mesh.parent) {
                     scene.remove(d.mesh); world.removeBody(d.body);
                     GAME.coins += 10; updateHUD();
                }
            });

            // 4. BULLETS
            for(let i=bullets.length-1; i>=0; i--) {
                const b = bullets[i];
                b.mesh.position.copy(b.body.position);
                b.life--;

                // Collision Check Boss
                enemies.forEach(boss => {
                    if(b.mesh.position.distanceTo(boss.mesh.position) < 4) {
                        boss.takeDamage(20);
                        b.life = 0;
                    }
                });

                // Collision Check Dummies
                dummies.forEach(d => {
                    if(b.mesh.position.distanceTo(d.mesh.position) < 2) {
                        d.hp -= 20;
                        d.mesh.material.color.setHex(0xffffff);
                        setTimeout(() => { if(d.mesh) d.mesh.material.color.setHex(0x00ff00); }, 50);
                        b.life = 0;
                    }
                });

                if(b.life <= 0) {
                    scene.remove(b.mesh);
                    world.removeBody(b.body);
                    bullets.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
