<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PolyCombat: RPG Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; user-select: none; }
        
        /* UI OVERLAY */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            background: cyan; border: 2px solid white; border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px cyan;
        }

        /* CURRENCY HUD */
        #currency-hud {
            position: absolute; top: 20px; right: 20px;
            text-align: right;
        }
        .currency { font-size: 24px; margin-bottom: 5px; text-shadow: 2px 2px 0 #000; }
        #gcoins-txt { color: #ffd700; } /* Gold */
        #ggems-txt { color: #d500f9; } /* Purple */

        /* BOSS HEALTH BAR */
        #boss-hud {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            width: 600px; display: none; /* Hidden until boss spawns */
        }
        #boss-name { color: red; font-size: 20px; text-align: center; text-shadow: 0 0 5px red; margin-bottom: 5px; }
        #boss-bar-bg { width: 100%; height: 20px; background: #330000; border: 2px solid red; }
        #boss-bar-fill { width: 100%; height: 100%; background: red; transition: width 0.1s; }

        /* PLAYER STATUS */
        #status-bar {
            position: absolute; bottom: 20px; left: 20px;
            color: white; font-size: 20px;
        }

        /* DAMAGE NUMBERS */
        .dmg-num {
            position: absolute; color: white; font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1s forwards;
            text-shadow: 2px 2px 0 #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: auto;
        }
        .btn {
            background: linear-gradient(45deg, #ff0000, #ff8800);
            border: none; padding: 20px 50px; font-size: 30px; color: white; font-weight: bold;
            cursor: pointer; transform: skewX(-10deg); box-shadow: 0 0 20px #ff0000;
        }
        .btn:hover { transform: skewX(-10deg) scale(1.1); }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white; font-size: 60px;">POLY COMBAT: RPG</h1>
        <p style="color:#aaa;">WASD to Move | CLICK to Shoot | KILL THE BOSS</p>
        <button class="btn" id="start-btn">ENTER ARENA</button>
    </div>

    <div id="dmg-layer" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>

    <div id="ui-layer">
        <div id="currency-hud">
            <div class="currency" id="gcoins-txt">ü™ô 0 Gcoins</div>
            <div class="currency" id="ggems-txt">üíé 0 GGems</div>
        </div>

        <div id="boss-hud">
            <div id="boss-name">MEGA TITAN (LVL 1)</div>
            <div id="boss-bar-bg"><div id="boss-bar-fill"></div></div>
        </div>

        <div id="crosshair"></div>
        
        <div id="status-bar">
            ‚ù§Ô∏è HEALTH: 100 | üî´ AMMO: ‚àû
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import * as CANNON from 'cannon-es';

        // --- GAME STATE ---
        const GAME = {
            active: false,
            gCoins: 0,
            gGems: 0,
            bossLevel: 1
        };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 10, 80);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(20, 40, 20);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Physics World
        const world = new CANNON.World();
        world.gravity.set(0, -30, 0);
        
        // Materials
        const groundMat = new CANNON.Material();
        const playerMat = new CANNON.Material();
        const physicsContact = new CANNON.ContactMaterial(groundMat, playerMat, { friction: 0.0, restitution: 0.0 });
        world.addContactMaterial(physicsContact);

        // --- PLAYER ---
        const playerBody = new CANNON.Body({
            mass: 5, shape: new CANNON.Sphere(1.5),
            material: playerMat, fixedRotation: true
        });
        playerBody.position.set(0, 5, 20);
        playerBody.linearDamping = 0.9;
        world.addBody(playerBody);

        // Weapon
        const gunMesh = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.6), new THREE.MeshStandardMaterial({color: 0x00ffff}));
        gunMesh.position.set(0.5, -0.4, -0.8);
        camera.add(gunMesh);
        scene.add(camera);

        // --- ENTITIES SYSTEM ---
        const enemies = [];
        
        class Entity {
            constructor(x, y, z, width, height, color, hp, name, isBoss = false) {
                this.maxHp = hp;
                this.hp = hp;
                this.isBoss = isBoss;
                this.name = name;

                // Visual
                const geo = new THREE.BoxGeometry(width, height, width);
                const mat = new THREE.MeshStandardMaterial({ color: color });
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.position.set(x, y, z);
                this.mesh.castShadow = true;
                scene.add(this.mesh);

                // Physics
                this.body = new CANNON.Body({
                    mass: isBoss ? 50 : 5, // Boss is heavy
                    shape: new CANNON.Box(new CANNON.Vec3(width/2, height/2, width/2)),
                    material: groundMat
                });
                this.body.position.set(x, y, z);
                world.addBody(this.body);

                enemies.push(this);
            }

            takeDamage(amount) {
                this.hp -= amount;
                
                // Flash White
                this.mesh.material.emissive.setHex(0xffffff);
                setTimeout(() => this.mesh.material.emissive.setHex(0x000000), 50);

                // Update Boss UI
                if(this.isBoss) {
                    const pct = Math.max(0, (this.hp / this.maxHp) * 100);
                    document.getElementById('boss-bar-fill').style.width = pct + "%";
                }

                // Show Damage Number (Visual HTML overlay)
                showDamageNumber(amount, this.mesh.position);

                if(this.hp <= 0) this.die();
            }

            die() {
                // Remove visuals/physics
                scene.remove(this.mesh);
                world.removeBody(this.body);
                
                // Remove from list
                const idx = enemies.indexOf(this);
                if(idx > -1) enemies.splice(idx, 1);

                // Rewards
                if(this.isBoss) {
                    GAME.gCoins += 1000;
                    GAME.gGems += 500;
                    updateEconomy();
                    alert("BOSS DEFEATED! +1000 Gcoins | +500 GGems");
                    
                    document.getElementById('boss-hud').style.display = 'none';
                    
                    // Respawn Boss Stronger
                    GAME.bossLevel++;
                    setTimeout(() => spawnBoss(), 3000);
                } else {
                    // Dummy Reward
                    GAME.gCoins += 10;
                    updateEconomy();
                    // Respawn Dummy
                    setTimeout(() => new Entity(this.body.position.x, 3, this.body.position.z, 2, 4, 0x00ff00, 500, "Dummy"), 2000);
                }
            }
        }

        // --- SPAWNERS ---
        
        // 1. Map Floors
        function createBox(w, h, d, x, y, z, col) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color:col}));
            m.position.set(x,y,z); scene.add(m);
            const b = new CANNON.Body({mass:0, shape:new CANNON.Box(new CANNON.Vec3(w/2,h/2,d/2))});
            b.position.set(x,y,z); world.addBody(b);
        }
        createBox(100, 2, 100, 0, -1, 0, 0x222222); // Main Floor

        // 2. Training Dummies (Left Side)
        new Entity(-20, 3, 0, 3, 5, 0x00ff00, 500, "Dummy");
        new Entity(-20, 3, 10, 3, 5, 0x00ff00, 500, "Dummy");
        new Entity(-20, 3, -10, 3, 5, 0x00ff00, 500, "Dummy");

        // 3. Boss Spawner
        function spawnBoss() {
            const hp = 1500 * GAME.bossLevel;
            const boss = new Entity(0, 8, -30, 6, 12, 0xff0000, hp, "Boss", true);
            
            // Show UI
            document.getElementById('boss-hud').style.display = 'block';
            document.getElementById('boss-name').innerText = `MEGA TITAN (LVL ${GAME.bossLevel})`;
            document.getElementById('boss-bar-fill').style.width = '100%';
        }
        spawnBoss();

        // --- CONTROLS ---
        const controls = new PointerLockControls(camera, document.body);
        const keys = { w:0, a:0, s:0, d:0, sp:0, sh:0 };

        document.getElementById('start-btn').addEventListener('click', () => {
            controls.lock();
            document.getElementById('start-screen').style.display = 'none';
            GAME.active = true;
        });

        document.addEventListener('keydown', e => {
            if(e.key === 'w') keys.w = 1;
            if(e.key === 's') keys.s = 1;
            if(e.key === 'a') keys.a = 1;
            if(e.key === 'd') keys.d = 1;
            if(e.code === 'Space') keys.sp = 1;
            if(e.key === 'Shift') keys.sh = 1;
        });
        document.addEventListener('keyup', e => {
            if(e.key === 'w') keys.w = 0;
            if(e.key === 's') keys.s = 0;
            if(e.key === 'a') keys.a = 0;
            if(e.key === 'd') keys.d = 0;
            if(e.code === 'Space') keys.sp = 0;
            if(e.key === 'Shift') keys.sh = 0;
        });
        document.addEventListener('mousedown', () => {
            if(GAME.active) shoot();
        });

        // --- SHOOTING ---
        const bullets = [];
        function shoot() {
            // Recoil
            gunMesh.position.z = -0.4;
            setTimeout(() => gunMesh.position.z = -0.8, 100);

            // Create Projectile
            const geo = new THREE.SphereGeometry(0.3);
            const mat = new THREE.MeshBasicMaterial({color: 0x00ffff});
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.copy(camera.position);
            
            // Physics
            const body = new CANNON.Body({mass: 0.2, shape: new CANNON.Sphere(0.3)});
            body.position.copy(camera.position);
            
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            const speed = 80;
            body.velocity.set(dir.x*speed, dir.y*speed, dir.z*speed);
            
            scene.add(mesh);
            world.addBody(body);
            bullets.push({mesh, body, life: 100});
        }

        // --- HELPERS ---
        function showDamageNumber(dmg, pos) {
            // Convert 3D pos to 2D screen pos
            const tempV = pos.clone();
            tempV.project(camera);
            
            const x = (tempV.x * .5 + .5) * window.innerWidth;
            const y = (tempV.y * -.5 + .5) * window.innerHeight;

            const div = document.createElement('div');
            div.className = 'dmg-num';
            div.innerText = "-" + dmg;
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            document.getElementById('dmg-layer').appendChild(div);
            
            setTimeout(() => div.remove(), 1000);
        }

        function updateEconomy() {
            document.getElementById('gcoins-txt').innerText = `ü™ô ${GAME.gCoins} Gcoins`;
            document.getElementById('ggems-txt').innerText = `üíé ${GAME.gGems} GGems`;
        }

        // --- LOOP ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if(!GAME.active) return;
            
            const dt = Math.min(clock.getDelta(), 0.1);
            world.step(1/60, dt, 3);

            // 1. Movement
            const yaw = new THREE.Euler(0, 0, 0, 'YXZ');
            yaw.setFromQuaternion(camera.quaternion);
            
            const input = new THREE.Vector3(0,0,0);
            if(keys.w) input.z -= 1;
            if(keys.s) input.z += 1;
            if(keys.a) input.x -= 1;
            if(keys.d) input.x += 1;
            input.applyAxisAngle(new THREE.Vector3(0,1,0), yaw.y);
            
            const speed = keys.sh ? 20 : 10;
            playerBody.velocity.x = input.x * speed;
            playerBody.velocity.z = input.z * speed;
            
            if(keys.sp && Math.abs(playerBody.velocity.y) < 0.1) {
                playerBody.velocity.y = 15;
            }

            camera.position.copy(playerBody.position).add(new THREE.Vector3(0, 1.2, 0));

            // 2. Entities
            enemies.forEach(e => {
                e.mesh.position.copy(e.body.position);
                e.mesh.quaternion.copy(e.body.quaternion);
                
                // Simple Boss AI: Move towards player slowly
                if(e.isBoss) {
                    const toPlayer = new THREE.Vector3().subVectors(playerBody.position, e.body.position);
                    toPlayer.y = 0; // Don't fly
                    toPlayer.normalize();
                    e.body.velocity.x = toPlayer.x * 3;
                    e.body.velocity.z = toPlayer.z * 3;
                    e.mesh.lookAt(playerBody.position);
                }
            });

            // 3. Bullets
            for(let i=bullets.length-1; i>=0; i--) {
                const b = bullets[i];
                b.mesh.position.copy(b.body.position);
                b.life--;

                // Collision
                let hit = false;
                enemies.forEach(e => {
                    if(b.mesh.position.distanceTo(e.mesh.position) < 4) { // Hitbox size
                        e.takeDamage(25); // Bullet Damage
                        hit = true;
                    }
                });

                if(b.life <= 0 || hit) {
                    scene.remove(b.mesh);
                    world.removeBody(b.body);
                    bullets.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
