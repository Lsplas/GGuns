<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PolyCombat: Neon Light</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        
        /* UI LAYERS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* BOSS HUD */
        #boss-hud {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            width: 600px; text-align: center; display: none;
        }
        #boss-name { 
            color: #ff3333; font-weight: 900; font-size: 28px; 
            text-shadow: 0 0 10px #ff0000; letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 5px;
        }
        #boss-bar-frame {
            width: 100%; height: 30px; background: #2a0000; 
            border: 4px solid #550000; transform: skewX(-20deg);
        }
        #boss-bar-fill {
            width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff5500); 
            transition: width 0.1s; box-shadow: 0 0 15px #ff0000;
        }

        /* WAVE TEXT */
        #wave-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; font-weight: 900; color: white; text-shadow: 0 0 20px #ff00ff;
            opacity: 0; transition: opacity 0.5s; text-align: center;
        }

        /* PLAYER STATS */
        #player-hud {
            position: absolute; bottom: 30px; left: 30px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .stat-row { display: flex; align-items: center; gap: 10px; }
        .stat-label { font-weight: bold; color: white; width: 80px; text-shadow: 2px 2px 0 #000; }
        .bar-bg { width: 250px; height: 15px; background: rgba(0,0,0,0.6); border: 2px solid #444; transform: skewX(-15deg); }
        .bar-fill { height: 100%; transition: width 0.1s; }
        
        #hp-fill { background: #00ff44; }
        #stamina-fill { background: #00ccff; }

        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: cyan; border: 2px solid white; border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px cyan;
        }
        
        /* DAMAGE FLASH */
        #dmg-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, red 150%);
            opacity: 0; transition: opacity 0.1s;
        }

        /* MENU */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20,0,30,0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: auto; z-index: 100;
        }
        h1 { font-size: 80px; color: white; font-style: italic; margin: 0; text-shadow: 0 0 20px #aa00ff; }
        p { color: #dcbfff; font-size: 20px; margin-bottom: 40px; }
        button {
            background: #aa00ff; color: white; border: none; padding: 20px 60px;
            font-size: 24px; font-weight: 900; cursor: pointer; transform: skewX(-10deg);
            border: 2px solid white; transition: 0.2s; box-shadow: 0 0 15px #aa00ff;
        }
        button:hover { background: white; color: #aa00ff; transform: skewX(-10deg) scale(1.1); }
    </style>
</head>
<body>

    <div id="dmg-flash"></div>
    <div id="wave-msg">WAVE 2<br><span style="font-size:30px; color:violet">SHADOW STALKER</span></div>

    <div id="menu">
        <h1>NEON COMBAT</h1>
        <p>WASD + Shift (Dash) + Click (Shoot)</p>
        <button id="play-btn">DEPLOY</button>
    </div>

    <div id="ui-layer">
        <div id="boss-hud">
            <div id="boss-name">BOSS</div>
            <div id="boss-bar-frame"><div id="boss-bar-fill"></div></div>
        </div>

        <div id="crosshair"></div>

        <div id="player-hud">
            <div class="stat-row">
                <div class="stat-label">HP</div>
                <div class="bar-bg"><div class="bar-fill" id="hp-fill" style="width:100%"></div></div>
            </div>
            <div class="stat-row">
                <div class="stat-label">STAMINA</div>
                <div class="bar-bg"><div class="bar-fill" id="stamina-fill" style="width:100%"></div></div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import * as CANNON from 'cannon-es';

        // --- CONFIG ---
        const CONFIG = {
            gravity: -30,
            playerSpeed: 25,
            dashSpeed: 80,
            bulletSpeed: 150
        };

        const GAME = { active: false, wave: 0 };

        // --- SCENE & SKY ---
        const scene = new THREE.Scene();
        
        // --- CHANGED: BRIGHT NEON PURPLE SKY ---
        const skyColor = 0x8800ff; // Bright Violet/Purple
        scene.background = new THREE.Color(skyColor); 
        scene.fog = new THREE.FogExp2(skyColor, 0.015);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.4); // Slightly brighter ambient for the light sky
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffccff, 1.0); // Whitish-Pink Sun
        sun.position.set(20, 50, 20);
        sun.castShadow = true;
        scene.add(sun);

        const rimLight = new THREE.DirectionalLight(0x00ffff, 0.5);
        rimLight.position.set(-20, 20, -20);
        scene.add(rimLight);

        const pLight = new THREE.PointLight(0x00ffff, 0.5, 20);
        camera.add(pLight);

        // --- PHYSICS ---
        const world = new CANNON.World();
        world.gravity.set(0, CONFIG.gravity, 0);
        const matDefault = new CANNON.Material();
        const matPlayer = new CANNON.Material();
        const matBoss = new CANNON.Material();
        
        world.addContactMaterial(new CANNON.ContactMaterial(matDefault, matPlayer, { friction: 0.0, restitution: 0 }));
        world.addContactMaterial(new CANNON.ContactMaterial(matDefault, matBoss, { friction: 0.0, restitution: 0 }));

        // --- SHAKE ---
        let shakeIntensity = 0;
        function addShake(amt) { shakeIntensity = amt; }
        function updateShake() {
            if(shakeIntensity > 0) {
                camera.position.x += (Math.random()-0.5)*shakeIntensity;
                camera.position.y += (Math.random()-0.5)*shakeIntensity;
                shakeIntensity *= 0.9;
                if(shakeIntensity < 0.01) shakeIntensity = 0;
            }
        }

        // --- PARTICLES ---
        const particles = [];
        function spawnParticles(pos, count, color) {
            const geo = new THREE.BoxGeometry(0.3, 0.3, 0.3);
            const mat = new THREE.MeshBasicMaterial({ color: color });
            for(let i=0; i<count; i++) {
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(pos);
                mesh.position.x += (Math.random()-0.5)*3;
                mesh.position.y += (Math.random()-0.5)*3;
                mesh.position.z += (Math.random()-0.5)*3;
                scene.add(mesh);
                particles.push({ 
                    mesh, 
                    vel: new THREE.Vector3((Math.random()-0.5)*15, Math.random()*15, (Math.random()-0.5)*15), 
                    life: 1.0 
                });
            }
        }

        // --- WEAPON ---
        const gunGroup = new THREE.Group();
        const gunMat = new THREE.MeshStandardMaterial({ color: 0x111, roughness:0.2, metalness:0.9 });
        const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.25, 0.8), gunMat);
        const gunBarrel = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.8), new THREE.MeshStandardMaterial({color:0xff00ff, emissive:0x440044}));
        gunBarrel.rotation.x = Math.PI/2; gunBarrel.position.z = -0.6;
        gunGroup.add(gunBody, gunBarrel);
        gunGroup.position.set(0.4, -0.35, -0.6);
        camera.add(gunGroup);
        scene.add(camera);

        // --- PLAYER ---
        class Player {
            constructor() {
                this.hp = 100;
                this.stamina = 100;
                this.body = new CANNON.Body({ mass: 5, shape: new CANNON.Sphere(1.5), material: matPlayer, fixedRotation: true });
                this.body.position.set(0, 5, 30);
                this.body.linearDamping = 0.9;
                world.addBody(this.body);
            }
            update(dt, input) {
                if(!input.shift) this.stamina = Math.min(100, this.stamina + dt*20);
                document.getElementById('stamina-fill').style.width = this.stamina + '%';

                const yaw = camera.rotation.y;
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
                const right = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);

                let speed = input.shift && this.stamina > 20 ? CONFIG.dashSpeed : CONFIG.playerSpeed;
                if(input.shift && this.stamina > 20) { this.stamina -= dt*60; camera.fov = THREE.MathUtils.lerp(camera.fov, 90, 0.1); }
                else camera.fov = THREE.MathUtils.lerp(camera.fov, 75, 0.1);
                camera.updateProjectionMatrix();

                const move = new THREE.Vector3();
                if(input.w) move.add(fwd); if(input.s) move.sub(fwd);
                if(input.d) move.add(right); if(input.a) move.sub(right);
                move.normalize();

                this.body.velocity.x = move.x * speed;
                this.body.velocity.z = move.z * speed;
                if(input.space && Math.abs(this.body.velocity.y) < 0.1) this.body.velocity.y = 15;

                camera.position.copy(this.body.position).add(new THREE.Vector3(0,1.5,0));
                updateShake();
                
                gunGroup.position.x = THREE.MathUtils.lerp(gunGroup.position.x, 0.4 + move.x * -0.05, 0.1);
                gunGroup.position.y = THREE.MathUtils.lerp(gunGroup.position.y, -0.35 + Math.sin(Date.now()*0.01)*0.01, 0.1);
            }
            takeDamage(amt) {
                this.hp -= amt;
                document.getElementById('hp-fill').style.width = this.hp + '%';
                addShake(0.5);
                const f = document.getElementById('dmg-flash'); f.style.opacity = 0.8;
                setTimeout(()=>f.style.opacity=0, 200);
                if(this.hp <= 0) { alert("MISSION FAILED"); location.reload(); }
            }
        }

        // --- BOSS ---
        class Boss {
            constructor(type) {
                this.type = type;
                this.maxHp = type === 1 ? 3000 : 6000;
                this.hp = this.maxHp;
                this.isDead = false;
                this.deathTimer = 0;
                
                // Attack Timers
                this.nextDash = Date.now() + 2000;
                this.nextSmash = Date.now() + 5000;
                this.isSmashing = false;
                this.isDashing = false;

                // Create Mesh
                this.mesh = new THREE.Group();
                const col = type === 1 ? 0x888899 : 0x050505;
                const glow = type === 1 ? 0x00ffff : 0xaa00ff;
                const mat = new THREE.MeshStandardMaterial({ color: col, metalness: 0.9, roughness: 0.1 });
                this.glowMat = new THREE.MeshBasicMaterial({ color: glow });

                const leg = new THREE.BoxGeometry(1.5, 4, 1.5);
                this.legL = new THREE.Mesh(leg, mat); this.legL.position.set(-1.5, 2, 0);
                this.legR = new THREE.Mesh(leg, mat); this.legR.position.set(1.5, 2, 0);
                const torso = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 2.5), mat); torso.position.y = 6.5;
                const head = new THREE.Mesh(new THREE.BoxGeometry(2, 2.5, 2), mat); head.position.y = 10;
                const eye = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.4, 0.2), this.glowMat); eye.position.set(0, 10, 1.0);
                
                this.armL = new THREE.Mesh(new THREE.BoxGeometry(1.2, 5, 1.2), mat); this.armL.position.set(-2.8, 7, 0);
                this.armR = new THREE.Group();
                this.armR.position.set(2.8, 7, 0);
                this.armR.add(new THREE.Mesh(new THREE.BoxGeometry(1.2, 5, 1.2), mat)); // Shoulder

                if(type === 1) {
                    const blade = new THREE.Mesh(new THREE.BoxGeometry(0.2, 8, 1), new THREE.MeshStandardMaterial({color:0xff0000, emissive:0x550000}));
                    blade.position.set(0, -6, 1); this.armR.add(blade);
                } else {
                    const h = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 8), new THREE.MeshStandardMaterial({color:0x333}));
                    h.position.set(0, -4, 1); h.rotation.x = Math.PI/2;
                    const b = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 3), new THREE.MeshStandardMaterial({color:0x5500aa, emissive: 0x220055}));
                    b.position.set(0, -8, 1); this.armR.add(h, b);
                }

                this.mesh.add(this.legL, this.legR, torso, head, eye, this.armL, this.armR);
                scene.add(this.mesh);

                this.body = new CANNON.Body({ mass: 400, fixedRotation: true, shape: new CANNON.Box(new CANNON.Vec3(2, 6, 2)), material: matBoss });
                this.body.position.set(0, 10, -40);
                this.body.linearDamping = 0.0; 
                world.addBody(this.body);

                // UI
                const hud = document.getElementById('boss-hud');
                hud.style.display = 'block';
                document.getElementById('boss-name').innerText = type===1 ? "IRON KNIGHT" : "SHADOW STALKER";
                document.getElementById('boss-name').style.color = type===1 ? "#ff3333" : "#aa00ff";
                document.getElementById('boss-bar-fill').style.width = '100%';
            }

            update(playerPos, dt) {
                if(this.isDead) {
                    this.deathTimer += dt;
                    this.mesh.rotation.x -= dt*2; this.mesh.position.y -= dt;
                    if(this.deathTimer > 3) { scene.remove(this.mesh); return true; }
                    return false;
                }

                const dist = this.body.position.distanceTo(playerPos);

                // --- SHADOW STALKER AI (Type 2) ---
                if(this.type === 2) {
                    // Smash & Dash logic
                    if(dist < 25 && Date.now() > this.nextSmash && !this.isSmashing && !this.isDashing) {
                        this.isSmashing = true;
                        this.body.velocity.y = 80;
                        setTimeout(() => { if(!this.isDead) this.body.velocity.set(0, -150, 0); }, 600);
                        setTimeout(() => {
                            if(!this.isDead && this.body.position.y < 5) {
                                addShake(4.0); spawnParticles(this.body.position, 80, 0xaa00ff);
                                if(this.body.position.distanceTo(player.body.position) < 30) player.takeDamage(35);
                                this.isSmashing = false;
                            }
                        }, 900);
                        this.nextSmash = Date.now() + 5000;
                    }
                    if(Date.now() > this.nextDash && !this.isSmashing && !this.isDashing) {
                        this.isDashing = true;
                        const dir = new THREE.Vector3().subVectors(playerPos, this.body.position).normalize();
                        this.body.velocity.x = dir.x * 150; this.body.velocity.z = dir.z * 150;
                        spawnParticles(this.body.position, 20, 0xaa00ff);
                        setTimeout(() => { this.isDashing = false; }, 600);
                        this.nextDash = Date.now() + 2500;
                    }
                    if(!this.isSmashing && !this.isDashing) {
                        const dir = new THREE.Vector3().subVectors(playerPos, this.body.position).normalize();
                        const speed = 40;
                        this.body.velocity.x = dir.x * speed; this.body.velocity.z = dir.z * speed;
                    }
                    const maxVel = this.isDashing ? 160 : 50;
                    const s = Math.sqrt(this.body.velocity.x**2 + this.body.velocity.z**2);
                    if(s > maxVel) { const f = maxVel/s; this.body.velocity.x*=f; this.body.velocity.z*=f; }

                } else {
                    // --- IRON KNIGHT AI (FAST) ---
                    const enraged = this.hp < this.maxHp * 0.5;
                    if(enraged) {
                        this.glowMat.color.setHex(0xff0000); 
                        if(Math.random()>0.9) spawnParticles(this.body.position, 1, 0xff0000);
                    }
                    const speed = enraged ? 70 : 40; 
                    const dir = new THREE.Vector3().subVectors(playerPos, this.body.position).normalize();
                    this.body.velocity.x = dir.x * speed;
                    this.body.velocity.z = dir.z * speed;
                }

                this.mesh.position.copy(this.body.position);
                this.mesh.position.y -= 6;
                this.mesh.lookAt(playerPos.x, this.mesh.position.y, playerPos.z);

                const t = Date.now() * 0.015;
                this.legL.rotation.x = Math.sin(t)*0.8;
                this.legR.rotation.x = Math.sin(t+Math.PI)*0.8;
                
                if(dist < 10 && !this.isSmashing) {
                    this.armR.rotation.x = -Math.PI/2 + Math.sin(t*3)*1.5;
                    if(Math.random()>0.95) player.takeDamage(1);
                } else {
                    this.armR.rotation.x = Math.sin(t)*0.2;
                }
                return false;
            }

            takeDamage(amt) {
                if(this.isDead) return;
                this.hp -= amt;
                document.getElementById('boss-bar-fill').style.width = (this.hp/this.maxHp)*100 + '%';
                
                this.mesh.children.forEach(c => { if(c.material) c.material.emissive = new THREE.Color(0xff0000); });
                setTimeout(() => {
                    this.mesh.children.forEach(c => { if(c.material) c.material.emissive = new THREE.Color(0x000000); });
                }, 50);

                if(this.hp <= 0) {
                    this.isDead = true;
                    world.removeBody(this.body);
                    addShake(2.0);
                    spawnParticles(this.mesh.position, 100, 0xffaa00);
                    
                    if(this.type === 1) setTimeout(startWave2, 3000);
                    else { alert("VICTORY! YOU SURVIVED THE NEON NIGHTMARE."); location.reload(); }
                }
            }
        }

        // --- GAME LOGIC ---
        let currentBoss = null;
        const player = new Player();

        function startWave1() { GAME.wave = 1; currentBoss = new Boss(1); }
        function startWave2() {
            GAME.wave = 2;
            const msg = document.getElementById('wave-msg');
            msg.style.opacity = 1; setTimeout(()=>msg.style.opacity=0, 3000);
            currentBoss = new Boss(2);
        }

        // --- ARENA ---
        const grid = new THREE.GridHelper(200, 50, 0xaa00ff, 0x220044); scene.add(grid); 
        const floor = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
        floor.quaternion.setFromEuler(-Math.PI/2, 0, 0); world.addBody(floor);
        const pillGeo = new THREE.BoxGeometry(4, 20, 4); const pillMat = new THREE.MeshStandardMaterial({color: 0x110022});
        [[-40,-40], [40,-40], [-40,40], [40,40]].forEach(p => {
            const m = new THREE.Mesh(pillGeo, pillMat); m.position.set(p[0], 10, p[1]); scene.add(m);
            const b = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(2,10,2)) }); b.position.set(p[0], 10, p[1]); world.addBody(b);
        });

        // --- INPUT ---
        const keys = { w:0, a:0, s:0, d:0, shift:0, space:0 };
        document.onkeydown = e => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; if(e.key==='Shift') keys.shift=true; if(e.code==='Space') keys.space=true; };
        document.onkeyup = e => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; if(e.key==='Shift') keys.shift=false; if(e.code==='Space') keys.space=false; };
        document.onmousedown = () => { if(GAME.active) shoot(); };

        const bullets = [];
        function shoot() {
            addShake(0.2); gunGroup.position.z += 0.3; gunGroup.rotation.x += 0.2;
            const m = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color:0x00ffff}));
            m.position.copy(camera.position); scene.add(m);
            const b = new CANNON.Body({ mass: 0.1, shape: new CANNON.Sphere(0.15) });
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
            b.velocity.set(dir.x*CONFIG.bulletSpeed, dir.y*CONFIG.bulletSpeed, dir.z*CONFIG.bulletSpeed);
            world.addBody(b);
            bullets.push({mesh:m, body:b, life:60});
        }

        const clock = new THREE.Clock();
        const controls = new PointerLockControls(camera, document.body);
        document.getElementById('play-btn').onclick = () => { controls.lock(); GAME.active = true; document.getElementById('menu').style.display='none'; startWave1(); };

        function animate() {
            requestAnimationFrame(animate);
            if(!GAME.active) return;
            const dt = Math.min(clock.getDelta(), 0.1);
            world.step(1/60, dt, 3);
            player.update(dt, keys);
            
            if(currentBoss) {
                if(currentBoss.update(player.body.position, dt)) currentBoss = null;
            }

            gunGroup.position.z = THREE.MathUtils.lerp(gunGroup.position.z, -0.6, 0.1);
            gunGroup.rotation.x = THREE.MathUtils.lerp(gunGroup.rotation.x, 0, 0.1);

            for(let i=bullets.length-1; i>=0; i--) {
                const b = bullets[i];
                b.mesh.position.copy(b.body.position);
                b.life--;
                if(currentBoss && !currentBoss.isDead && b.mesh.position.distanceTo(currentBoss.mesh.position) < 5) {
                    currentBoss.takeDamage(15); spawnParticles(b.mesh.position, 5, 0x00ffff);
                    scene.remove(b.mesh); world.removeBody(b.body); bullets.splice(i,1); continue;
                }
                if(b.life<=0 || b.mesh.position.y<0) { scene.remove(b.mesh); world.removeBody(b.body); bullets.splice(i,1); }
            }
            for(let i=particles.length-1; i>=0; i--) {
                const p = particles[i]; p.life -= dt;
                p.mesh.position.addScaledVector(p.vel, dt); p.mesh.scale.setScalar(p.life);
                if(p.life<=0) { scene.remove(p.mesh); particles.splice(i,1); }
            }
            renderer.render(scene, camera);
        }
        window.onresize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
        animate();
    </script>
</body>
</html>
